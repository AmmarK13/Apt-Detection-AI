```python
import pandas as pd
import seaborn as sns 
import matplotlib.pyplot as plt
import numpy as np

#load dataset
file_path = "/home/kay/Documents/Workspace-S25/SE/SeProject/APT DETECTION/z.after mids progress/dataset/Friday-WorkingHours-Afternoon-DDos.pcap_ISCX.csv"
df = pd.read_csv(file_path)

# Ensure the 'Label' column is numeric (1 = Attack, 0 = Benign)
df["Label"] = df["Label"].astype(int)

# --- Step 1: Remove features highly correlated with Label (leakage) ---
# Compute correlations with Label
label_correlation = df.corr()["Label"].abs().sort_values(ascending=False)

# Set threshold for leakage (adjust as needed)
LEAKAGE_THRESHOLD = 0.5
leaky_features = label_correlation[label_correlation > LEAKAGE_THRESHOLD]

# Remove 'Label' from leaky_features
if "Label" in leaky_features.index:
    leaky_features = leaky_features.drop("Label")

print("\n--- Features Correlated with Label (Leakage Candidates) ---")
print(f"Threshold: > {LEAKAGE_THRESHOLD}")
print(leaky_features.to_string(header=False))  # Print features + correlation values

# Drop leaky features
df_cleaned = df.drop(columns=leaky_features.index.tolist())

# --- Step 2: Remove redundant features (correlated with each other) ---
# Compute feature-feature correlation matrix (exclude Label)
corr_matrix = df_cleaned.drop(columns=["Label"]).corr().abs()

# Find all feature pairs with correlation > 0.9
redundant_pairs = []
for i in range(len(corr_matrix.columns)):
    for j in range(i + 1, len(corr_matrix.columns)):
        feature_i = corr_matrix.columns[i]
        feature_j = corr_matrix.columns[j]
        corr_value = corr_matrix.iloc[i, j]
        if corr_value > 0.9:
            redundant_pairs.append((feature_i, feature_j, corr_value))

# Print redundant pairs with correlation values
print("\n--- Redundant Feature Pairs (Correlation > 0.9) ---")
for pair in redundant_pairs:
    print(f"{pair[0]} <-> {pair[1]} : {pair[2]:.4f}")

# Identify columns to drop (from upper triangle)
upper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(bool))
to_drop = [col for col in upper.columns if any(upper[col] > 0.9)]
# After identifying "to_drop", retain critical features
CRITICAL_FEATURES = ["SYN Flag Count", "ECE Flag Count", "Bwd IAT Max", "Fwd Packets/s"]
to_drop = [col for col in to_drop if col not in CRITICAL_FEATURES]

print(f"Final features to drop: {to_drop}")
df_cleaned = df_cleaned.drop(columns=to_drop)

# --- Save cleaned dataset ---
cleaned_file_path = file_path.replace(".csv", "_CLEANED.csv")
df_cleaned.to_csv(cleaned_file_path, index=False)
print(f"\nCleaned dataset saved to: {cleaned_file_path}")

# --- Diagnostics ---
print("\nOriginal columns:", len(df.columns))
print("Remaining columns:", len(df_cleaned.columns))
```

```

--- Features Correlated with Label (Leakage Candidates) ---
Threshold: > 0.5
Bwd Packet Length Mean    0.599953
Avg Bwd Segment Size      0.599953
Bwd Packet Length Max     0.573842
Bwd Packet Length Std     0.572767
Destination Port          0.520359

--- Redundant Feature Pairs (Correlation > 0.9) ---
Flow Duration <-> Flow IAT Max : 0.9200
Flow Duration <-> Fwd IAT Total : 0.9970
Flow Duration <-> Fwd IAT Max : 0.9177
Flow Duration <-> Idle Max : 0.9190
Total Fwd Packets <-> Total Backward Packets : 0.9568
Total Fwd Packets <-> Total Length of Bwd Packets : 0.9385
Total Fwd Packets <-> Fwd Header Length : 0.9684
Total Fwd Packets <-> Bwd Header Length : 0.9288
Total Fwd Packets <-> Fwd Header Length.1 : 0.9684
Total Fwd Packets <-> Subflow Fwd Packets : 1.0000
Total Fwd Packets <-> Subflow Bwd Packets : 0.9568
Total Fwd Packets <-> Subflow Bwd Bytes : 0.9385
Total Backward Packets <-> Total Length of Bwd Packets : 0.9704
Total Backward Packets <-> Fwd Header Length : 0.9397
Total Backward Packets <-> Bwd Header Length : 0.9756
Total Backward Packets <-> Fwd Header Length.1 : 0.9397
Total Backward Packets <-> Subflow Fwd Packets : 0.9568
Total Backward Packets <-> Subflow Bwd Packets : 1.0000
Total Backward Packets <-> Subflow Bwd Bytes : 0.9704
Total Length of Fwd Packets <-> Subflow Fwd Bytes : 1.0000
Total Length of Bwd Packets <-> Fwd Header Length : 0.9231
Total Length of Bwd Packets <-> Bwd Header Length : 0.9454
Total Length of Bwd Packets <-> Fwd Header Length.1 : 0.9231
Total Length of Bwd Packets <-> Subflow Fwd Packets : 0.9385
Total Length of Bwd Packets <-> Subflow Bwd Packets : 0.9704
Total Length of Bwd Packets <-> Subflow Bwd Bytes : 1.0000
Fwd Packet Length Max <-> Fwd Packet Length Mean : 0.9409
Fwd Packet Length Max <-> Fwd Packet Length Std : 0.9917
Fwd Packet Length Max <-> Avg Fwd Segment Size : 0.9409
Fwd Packet Length Mean <-> Fwd Packet Length Std : 0.9196
Fwd Packet Length Mean <-> Avg Fwd Segment Size : 1.0000
Fwd Packet Length Std <-> Avg Fwd Segment Size : 0.9196
Flow Packets/s <-> Fwd Packets/s : 0.9821
Flow IAT Mean <-> Flow IAT Std : 0.9172
Flow IAT Mean <-> Fwd IAT Mean : 0.9210
Flow IAT Std <-> Flow IAT Max : 0.9780
Flow IAT Std <-> Fwd IAT Std : 0.9355
Flow IAT Std <-> Fwd IAT Max : 0.9692
Flow IAT Std <-> Idle Mean : 0.9380
Flow IAT Std <-> Idle Max : 0.9758
Flow IAT Max <-> Fwd IAT Total : 0.9171
Flow IAT Max <-> Fwd IAT Std : 0.9716
Flow IAT Max <-> Fwd IAT Max : 0.9953
Flow IAT Max <-> Idle Mean : 0.9495
Flow IAT Max <-> Idle Max : 0.9973
Fwd IAT Total <-> Fwd IAT Max : 0.9213
Fwd IAT Total <-> Idle Max : 0.9163
Fwd IAT Std <-> Fwd IAT Max : 0.9804
Fwd IAT Std <-> Idle Mean : 0.9128
Fwd IAT Std <-> Idle Max : 0.9698
Fwd IAT Max <-> Idle Mean : 0.9400
Fwd IAT Max <-> Idle Max : 0.9930
Fwd IAT Min <-> Bwd IAT Min : 0.9061
Bwd IAT Std <-> Bwd IAT Max : 0.9586
Fwd PSH Flags <-> SYN Flag Count : 1.0000
Fwd Header Length <-> Bwd Header Length : 0.9527
Fwd Header Length <-> Fwd Header Length.1 : 1.0000
Fwd Header Length <-> Subflow Fwd Packets : 0.9684
Fwd Header Length <-> Subflow Bwd Packets : 0.9397
Fwd Header Length <-> Subflow Bwd Bytes : 0.9231
Bwd Header Length <-> Fwd Header Length.1 : 0.9527
Bwd Header Length <-> Subflow Fwd Packets : 0.9288
Bwd Header Length <-> Subflow Bwd Packets : 0.9756
Bwd Header Length <-> Subflow Bwd Bytes : 0.9454
Max Packet Length <-> Packet Length Mean : 0.9033
Max Packet Length <-> Packet Length Std : 0.9839
Max Packet Length <-> Packet Length Variance : 0.9301
Packet Length Mean <-> Packet Length Std : 0.9507
Packet Length Mean <-> Average Packet Size : 0.9994
Packet Length Std <-> Packet Length Variance : 0.9496
Packet Length Std <-> Average Packet Size : 0.9501
RST Flag Count <-> ECE Flag Count : 1.0000
Fwd Header Length.1 <-> Subflow Fwd Packets : 0.9684
Fwd Header Length.1 <-> Subflow Bwd Packets : 0.9397
Fwd Header Length.1 <-> Subflow Bwd Bytes : 0.9231
Subflow Fwd Packets <-> Subflow Bwd Packets : 0.9568
Subflow Fwd Packets <-> Subflow Bwd Bytes : 0.9385
Subflow Bwd Packets <-> Subflow Bwd Bytes : 0.9704
Active Mean <-> Active Max : 0.9343
Active Mean <-> Active Min : 0.9827
Idle Mean <-> Idle Max : 0.9525
Idle Mean <-> Idle Min : 0.9107
Final features to drop: ['Total Backward Packets', 'Total Length of Bwd Packets', 'Fwd Packet Length Mean', 'Fwd Packet Length Std', 'Flow IAT Std', 'Flow IAT Max', 'Fwd IAT Total', 'Fwd IAT Mean', 'Fwd IAT Std', 'Fwd IAT Max', 'Bwd IAT Min', 'Fwd Header Length', 'Bwd Header Length', 'Packet Length Mean', 'Packet Length Std', 'Packet Length Variance', 'Average Packet Size', 'Avg Fwd Segment Size', 'Fwd Header Length.1', 'Subflow Fwd Packets', 'Subflow Fwd Bytes', 'Subflow Bwd Packets', 'Subflow Bwd Bytes', 'Active Max', 'Active Min', 'Idle Mean', 'Idle Max', 'Idle Min']

Cleaned dataset saved to: /home/kay/Documents/Workspace-S25/SE/SeProject/APT DETECTION/z.after mids progress/dataset/Friday-WorkingHours-Afternoon-DDos.pcap_ISCX_CLEANED.csv

Original columns: 79
Remaining columns: 46
```

![[images/Pasted image 20250329050854.png]]
